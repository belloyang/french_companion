<div class="flex flex-col h-screen max-w-4xl mx-auto font-sans">
  <!-- Header -->
  <header class="sticky top-0 z-20 flex items-center justify-between p-4 bg-white border-b border-slate-200 dark:bg-slate-800 dark:border-slate-700">
    <div class="flex items-center space-x-3">
      <div class="p-2 text-white bg-blue-600 rounded-full">
        <i class="fa-solid fa-comments"></i>
      </div>
      <div>
        <h1 class="text-lg font-bold text-slate-800 dark:text-white">French Companion</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">Your personal AI tutor 'Ami'</p>
      </div>
    </div>
     <button (click)="toggleVocabularyBank()" class="relative px-3 py-2 text-sm font-medium transition-colors rounded-md text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700">
      <i class="fa-solid fa-book-bookmark"></i>
      <span class="hidden ml-2 sm:inline">Vocabulary</span>
      @if (vocabularyBank().length > 0) {
        <span class="absolute top-0 right-0 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-600 rounded-full -translate-y-1/2 translate-x-1/3">
          {{ vocabularyBank().length }}
        </span>
      }
    </button>
  </header>

  <!-- Chat Messages -->
  <main #chatContainer class="flex-1 p-6 overflow-y-auto bg-slate-50 dark:bg-slate-900">
    <div class="flex flex-col space-y-4">
      @for (message of messages(); track $index; let isLast = $last) {
        @if (message.role === 'model') {
          <div class="flex items-end justify-start space-x-2">
            <div class="w-full max-w-lg">
              <div class="px-4 py-3 bg-white rounded-2xl dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <p class="text-sm whitespace-pre-wrap">{{ message.text }}</p>
              </div>
              <!-- New Vocabulary Section -->
              @if (message.vocabulary && message.vocabulary.length > 0) {
                <div class="px-4 pt-3 mt-2">
                  <h4 class="mb-2 text-xs font-bold tracking-wider uppercase text-slate-500 dark:text-slate-400">New Vocabulary</h4>
                  <div class="flex flex-wrap gap-2">
                    @for(item of message.vocabulary; track item.word) {
                      <div class="flex items-center p-2 text-sm border rounded-lg bg-slate-100 dark:bg-slate-800 dark:border-slate-700">
                        <div class="flex-grow">
                          <span class="font-semibold text-blue-700 dark:text-blue-400">{{ item.word }}</span>:
                          <span class="text-slate-600 dark:text-slate-300">{{ item.translation }}</span>
                        </div>
                        <button (click)="addWordToBank(item)" [disabled]="isWordInBank(item)"
                          class="ml-3 p-1.5 text-xs leading-none rounded-full transition-colors"
                          [class.text-slate-400]="isWordInBank(item)"
                          [class.cursor-not-allowed]="isWordInBank(item)"
                          [class.bg-slate-200]="isWordInBank(item)"
                          [class.dark:bg-slate-600]="isWordInBank(item)"
                          [class.text-blue-600]="!isWordInBank(item)"
                          [class.hover:bg-blue-100]="!isWordInBank(item)"
                          [class.dark:text-blue-400]="!isWordInBank(item)"
                          [class.dark:hover:bg-blue-900/50]="!isWordInBank(item)"
                          [attr.aria-label]="isWordInBank(item) ? 'Saved' : 'Save word'">
                          <i class="fa-solid" [class.fa-check]="isWordInBank(item)" [class.fa-plus]="!isWordInBank(item)"></i>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
            @if (isLast && isSpeaking()) {
              <i class="self-center mb-2 text-blue-500 fa-solid fa-volume-high animate-pulse"></i>
            }
          </div>
        } @else {
          <div class="flex justify-end">
            <div class="max-w-lg px-4 py-3 text-white bg-blue-600 rounded-2xl">
              <p class="text-sm whitespace-pre-wrap">{{ message.text }}</p>
            </div>
          </div>
        }
      }
      @if (isLoading() && (!messages().length || messages()[messages().length-1].role === 'user')) {
        <div class="flex justify-start">
          <div class="max-w-lg px-4 py-3 bg-white rounded-2xl dark:bg-slate-700 text-slate-800 dark:text-slate-200">
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
              <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
              <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
            </div>
          </div>
        </div>
      }
      @if (error()) {
        <div class="flex justify-center">
            <div class="px-4 py-3 text-sm text-red-700 bg-red-100 border border-red-400 rounded-lg dark:bg-red-900 dark:text-red-300 dark:border-red-800" role="alert">
                <span class="font-bold">Error:</span> {{ error() }}
            </div>
        </div>
      }
    </div>
  </main>

  <!-- Input Area -->
  <footer class="p-4 bg-white border-t border-slate-200 dark:bg-slate-800 dark:border-slate-700">
    <div class="flex flex-col items-center justify-center">
      <button 
        (click)="toggleRecording()" 
        [disabled]="isLoading()"
        class="flex items-center justify-center w-16 h-16 text-white transition-colors duration-200 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        [class.bg-red-600]="isRecording()" [class.hover:bg-red-700]="isRecording()"
        [class.bg-blue-600]="!isRecording()" [class.hover:bg-blue-700]="!isRecording()"
        [class.bg-slate-400]="isLoading()" [class.dark:bg-slate-600]="isLoading()"
        [class.cursor-not-allowed]="isLoading()">
        <i class="text-2xl fa-solid" [class.fa-microphone-slash]="isRecording()" [class.fa-microphone]="!isRecording()"></i>
      </button>
      @if (isRecording()) {
        <p class="mt-2 text-sm text-center text-slate-500 dark:text-slate-400">Listening...</p>
      } @else {
        <p class="mt-2 text-sm text-center text-slate-500 dark:text-slate-400">Tap to speak</p>
      }
    </div>
  </footer>
</div>

<!-- Vocabulary Bank Modal -->
@if (showVocabularyBank()) {
  <app-vocabulary-bank [vocabulary]="vocabularyBank()" (close)="toggleVocabularyBank()"></app-vocabulary-bank>
}
