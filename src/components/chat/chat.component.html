<div 
  class="flex flex-col h-screen max-w-4xl mx-auto bg-cover bg-center bg-fixed transition-all duration-500"
  [style]="backgroundStyle()">
  <!-- Header -->
  <header class="sticky top-0 z-20 flex items-center justify-between p-4 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md shrink-0 shadow-sm">
    <div class="flex items-center min-w-0 space-x-4">
      @if (activeScenario(); as scenario) {
        <div class="flex items-center justify-center w-12 h-12 text-xl text-white rounded-full bg-indigo-500 shrink-0">
          <i class="fa-solid {{ scenario.icon }}"></i>
        </div>
        <div class="min-w-0">
          <h1 class="text-lg font-bold truncate text-slate-800 dark:text-white">{{ scenario.title }}</h1>
          <p class="text-sm truncate text-slate-500 dark:text-slate-400">{{ scenario.objective }}</p>
        </div>
      } @else if (activeGrammarTopic(); as topic) {
        <div class="flex items-center justify-center w-12 h-12 text-xl text-white rounded-full bg-teal-500 shrink-0">
          <i class="fa-solid {{ topic.icon }}"></i>
        </div>
        <div class="min-w-0">
          <h1 class="text-lg font-bold truncate text-slate-800 dark:text-white">{{ topic.title }}</h1>
          <p class="text-sm truncate text-slate-500 dark:text-slate-400">Grammar Practice</p>
        </div>
      } @else if (activeMicroLesson(); as drillTopic) {
        <div class="flex items-center justify-center w-12 h-12 text-xl text-white rounded-full bg-orange-500 shrink-0">
          <i class="fa-solid fa-bolt"></i>
        </div>
        <div class="min-w-0">
          <h1 class="text-lg font-bold truncate text-slate-800 dark:text-white">Quick Drill</h1>
          <p class="text-sm truncate text-slate-500 dark:text-slate-400">{{ drillTopic }}</p>
        </div>
      } @else {
        <img [src]="activeTutor().avatar + '&size=48x48'" [alt]="activeTutor().name + ' avatar'" class="w-12 h-12 rounded-full shrink-0 border-2 border-white dark:border-slate-700">
        <div>
           <h1 class="text-lg font-bold text-slate-800 dark:text-white">Conversation with {{activeTutor().name}}</h1>
           <p class="text-sm text-slate-500 dark:text-slate-400">Free-form chat</p>
        </div>
      }
      @if(activeScenario() || activeGrammarTopic() || activeMicroLesson()) {
         <button (click)="exitSpecialMode()" class="flex-shrink-0 ml-2 px-2.5 py-1.5 text-xs font-medium transition-colors rounded-lg text-slate-500 hover:bg-zinc-100 dark:text-slate-400 dark:hover:bg-slate-700">
          <i class="fa-solid fa-xmark"></i>
          <span class="hidden ml-1 sm:inline">{{ activeMicroLesson() ? 'End Drill' : 'Exit' }}</span>
        </button>
      }
    </div>
    <div class="flex items-center space-x-2">
      @if(!activeScenario() && !activeGrammarTopic() && !activeMicroLesson()) {
        <button (click)="endSessionAndShowReview()" class="px-3 py-2 text-sm font-medium transition-colors rounded-lg text-rose-500 hover:bg-rose-100 dark:text-rose-400 dark:hover:bg-rose-900/50">
          <i class="fa-solid fa-flag-checkered"></i>
          <span class="hidden ml-2 sm:inline">End Session</span>
        </button>
      }
      <button (click)="toggleVocabularyBank()" class="relative px-3 py-2 text-sm font-medium transition-colors rounded-lg text-slate-500 hover:bg-zinc-100 dark:text-slate-400 dark:hover:bg-slate-700">
        <i class="fa-solid fa-book-bookmark"></i>
        <span class="hidden ml-2 sm:inline">Vocabulary</span>
        @if (wordsDueForReview().length > 0) {
          <span class="absolute top-0 right-0 flex items-center justify-center w-5 h-5 text-xs font-bold text-white rounded-full bg-indigo-500 -translate-y-1/2 translate-x-1/3">
            {{ wordsDueForReview().length }}
          </span>
        }
      </button>

      <!-- New Settings Dropdown -->
      <div class="relative">
        <button (click)="toggleSettings()" title="Settings" class="flex items-center justify-center w-10 h-10 text-lg transition-colors rounded-full text-slate-500 hover:bg-zinc-100 dark:text-slate-400 dark:hover:bg-slate-700">
          <i class="fa-solid fa-gear"></i>
        </button>
        @if (showSettings()) {
          <div class="absolute right-0 z-30 w-72 mt-2 p-2 origin-top-right bg-white border rounded-lg shadow-xl dark:bg-slate-800 dark:border-slate-700 focus:outline-none animate-scale-in">
            <!-- Speed Controls -->
            <div class="py-1">
              <p class="px-2 py-1 text-xs font-semibold tracking-wider uppercase text-slate-400 dark:text-slate-500">Speed</p>
              <div class="flex p-1 mt-1 space-x-1 bg-zinc-100 dark:bg-slate-900/50 rounded-lg">
                <button (click)="changeSpeakingRate(0.75)" class="w-full px-2 py-1 text-sm rounded-md transition-colors" [class.bg-white]="userSettings().speakingRate === 0.75" [class.dark:bg-slate-700]="userSettings().speakingRate === 0.75" [class.text-indigo-500]="userSettings().speakingRate === 0.75">Slow</button>
                <button (click)="changeSpeakingRate(1)" class="w-full px-2 py-1 text-sm rounded-md transition-colors" [class.bg-white]="userSettings().speakingRate === 1" [class.dark:bg-slate-700]="userSettings().speakingRate === 1" [class.text-indigo-500]="userSettings().speakingRate === 1">Normal</button>
                <button (click)="changeSpeakingRate(1.5)" class="w-full px-2 py-1 text-sm rounded-md transition-colors" [class.bg-white]="userSettings().speakingRate === 1.5" [class.dark:bg-slate-700]="userSettings().speakingRate === 1.5" [class.text-indigo-500]="userSettings().speakingRate === 1.5">Fast</button>
              </div>
            </div>
            <!-- Tutor Selection -->
            <div class="py-1 mt-2">
              <p class="px-2 py-1 text-xs font-semibold tracking-wider uppercase text-slate-400 dark:text-slate-500">Tutor</p>
              <div class="mt-2 space-y-2">
                @for(tutor of tutors; track tutor.name) {
                  <button (click)="changeTutor(tutor.name)" class="flex items-center w-full p-2 text-left transition-colors rounded-lg hover:bg-zinc-100 dark:hover:bg-slate-700/50"
                    [class.bg-indigo-50]="userSettings().tutorName === tutor.name"
                    [class.dark:bg-indigo-900/30]="userSettings().tutorName === tutor.name">
                    <img [src]="tutor.avatar + '&size=40x40'" [alt]="tutor.name + ' avatar'" class="w-10 h-10 rounded-full shrink-0">
                    <div class="ml-3">
                      <h4 class="text-sm font-semibold text-slate-800 dark:text-slate-100">{{tutor.name}}</h4>
                      <p class="text-xs text-slate-500 dark:text-slate-400">{{tutor.description}}</p>
                    </div>
                     @if (userSettings().tutorName === tutor.name) { 
                       <i class="ml-auto text-lg fa-solid fa-check-circle text-indigo-500"></i> 
                     }
                  </button>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  </header>

  <!-- Chat Messages -->
  <main #chatContainer class="flex-1 p-6 overflow-y-auto" [class.bg-transparent]="activeScenario()" [class.bg-zinc-50]="!activeScenario()" [class.dark:bg-slate-900]="!activeScenario()">
    <div class="flex flex-col space-y-4">
      @for (message of messages(); track $index; let isLast = $last) {
        @if (message.role === 'model') {
          <div class="flex items-start justify-start space-x-3 animate-fade-in-up">
            <img [src]="activeTutor().avatar + '&size=40x40'" [alt]="activeTutor().name + ' avatar'" class="w-10 h-10 rounded-full shrink-0">
            <div class="w-full max-w-lg">
              <div class="px-4 py-3 bg-white rounded-2xl shadow-sm dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                <p class="text-sm whitespace-pre-wrap">{{ message.text }}</p>
              </div>
              <!-- New Vocabulary Section -->
              @if (message.vocabulary && message.vocabulary.length > 0) {
                <div class="px-4 pt-3 mt-2">
                  <h4 class="mb-2 text-xs font-bold tracking-wider uppercase text-slate-500 dark:text-slate-400">New Vocabulary</h4>
                  <div class="flex flex-wrap gap-2">
                    @for(item of message.vocabulary; track item.word) {
                      <div class="flex items-center p-2 text-sm border rounded-lg shadow-sm bg-white dark:bg-slate-800 dark:border-slate-700">
                        <div class="flex-grow">
                          <button (click)="speakWord(item.word)" class="font-semibold text-indigo-600 dark:text-indigo-400 hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-sm">
                            {{ item.word }} <i class="ml-1 text-xs fa-solid fa-volume-high"></i>
                          </button>:
                          <span class="text-slate-600 dark:text-slate-300">{{ item.translation }}</span>
                        </div>
                        <button (click)="addWordToBank(item)" [disabled]="isWordInBank(item)"
                          class="ml-3 p-1.5 text-xs leading-none rounded-full transition-colors"
                          [class.text-slate-400]="isWordInBank(item)"
                          [class.cursor-not-allowed]="isWordInBank(item)"
                          [class.bg-zinc-200]="isWordInBank(item)"
                          [class.dark:bg-slate-600]="isWordInBank(item)"
                          [class.text-indigo-500]="!isWordInBank(item)"
                          [class.hover:bg-indigo-100]="!isWordInBank(item)"
                          [class.dark:text-indigo-400]="!isWordInBank(item)"
                          [class.dark:hover:bg-indigo-900/50]="!isWordInBank(item)"
                          [attr.aria-label]="isWordInBank(item) ? 'Saved' : 'Save word'">
                          <i class="fa-solid" [class.fa-check]="isWordInBank(item)" [class.fa-plus]="!isWordInBank(item)"></i>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
              <!-- Micro-Lesson Suggestion -->
              @if(isLast && microLessonSuggestion(); as suggestion) {
                <div class="p-4 mt-2 border-l-4 rounded-r-lg bg-indigo-50 border-indigo-500 dark:bg-indigo-900/30 dark:border-indigo-600 animate-fade-in-up">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="text-xl text-indigo-500 fa-solid fa-lightbulb"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-indigo-700 dark:text-indigo-200">{{ suggestion.reason }}</p>
                            <div class="mt-3 space-x-2">
                                <button (click)="startMicroLesson(suggestion)" class="px-3 py-1.5 text-xs font-semibold text-white bg-indigo-500 rounded-md hover:bg-indigo-600">Yes, please</button>
                                <button (click)="declineMicroLesson()" class="px-3 py-1.5 text-xs font-semibold text-indigo-700 bg-transparent rounded-md hover:bg-indigo-100 dark:text-indigo-200 dark:hover:bg-indigo-900/50">No, thanks</button>
                            </div>
                        </div>
                    </div>
                </div>
              }
            </div>
            @if (isLast && isSpeaking()) {
              <i class="self-center mb-2 text-indigo-500 fa-solid fa-volume-high animate-pulse"></i>
            }
          </div>
        } @else {
          <div class="flex items-start justify-end space-x-3 animate-fade-in-up">
            <div class="flex flex-col items-end w-full max-w-lg">
              <!-- User Message Bubble -->
              <div class="px-4 py-3 text-white rounded-2xl bg-indigo-500 shadow-md">
                <p class="text-sm whitespace-pre-wrap">{{ message.text }}</p>
              </div>
              <!-- Pronunciation Feedback -->
              @if(message.pronunciationFeedback; as feedback) {
                <div class="w-full max-w-sm mt-2 p-4 text-sm border rounded-xl shadow-sm bg-white dark:bg-slate-800 dark:border-slate-700">
                    <div class="flex items-center justify-between pb-2 mb-2 border-b dark:border-slate-700">
                      <h4 class="font-semibold text-slate-700 dark:text-slate-200">Pronunciation Feedback</h4>
                      <div class="relative flex-shrink-0 flex items-center justify-center w-12 h-12">
                          <svg class="w-full h-full transform -rotate-90" viewBox="0 0 44 44">
                              <circle class="text-slate-200 dark:text-slate-600" stroke-width="4" stroke="currentColor" fill="transparent" r="20" cx="22" cy="22" />
                              <circle class="text-amber-400 transition-all duration-500 ease-in-out" stroke-width="4" [style.stroke-dasharray]="circumference" [style.stroke-dashoffset]="calculateScoreOffset(feedback.score)" stroke-linecap="round" stroke="currentColor" fill="transparent" r="20" cx="22" cy="22" />
                          </svg>
                          <span class="absolute text-base font-bold text-slate-700 dark:text-slate-200">{{feedback.score}}</span>
                      </div>
                    </div>
                    <p class="text-slate-600 dark:text-slate-300">{{ feedback.feedback }}</p>
                    <div class="mt-2 pt-2 border-t dark:border-slate-700">
                      <p class="text-slate-500 dark:text-slate-400"><i class="fa-solid fa-lightbulb mr-2 text-indigo-500"></i><span class="font-semibold">Tip:</span> {{ feedback.tip }}</p>
                    </div>
                </div>
              }
            </div>
             <img src="https://robohash.org/user.png?set=set5&bgset=bg2&size=40x40" alt="User avatar" class="w-10 h-10 rounded-full shrink-0">
          </div>
        }
      }
      @if (isLoading() && (!messages().length || messages()[messages().length-1].role === 'user')) {
        <div class="flex items-start justify-start space-x-3 animate-fade-in-up">
          <div class="relative shrink-0">
             <img [src]="activeTutor().avatar + '&size=40x40'" [alt]="activeTutor().name + ' avatar'" class="w-10 h-10 rounded-full">
             <div class="absolute inset-0 border-2 rounded-full border-indigo-500 animate-pulse"></div>
          </div>
          <div class="max-w-lg px-4 py-3 bg-white rounded-2xl dark:bg-slate-700 shadow-sm">
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Thinking...</p>
          </div>
        </div>
      }
      @if (error()) {
        <div class="flex justify-center animate-fade-in-up">
            <div class="px-4 py-3 text-sm text-red-700 bg-red-100 border border-red-400 rounded-lg dark:bg-red-900 dark:text-red-300 dark:border-red-800" role="alert">
                <span class="font-bold">Error:</span> {{ error() }}
            </div>
        </div>
      }
    </div>
  </main>

  <!-- Input Area -->
  <footer class="p-4 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md shadow-[0_-2px_5px_rgba(0,0,0,0.05)] dark:shadow-[0_-2px_5px_rgba(0,0,0,0.2)]">
    <div class="flex items-end w-full max-w-xl mx-auto space-x-4">
      <!-- Main Input Area -->
      <div class="flex-1">
        @if (chatMode() === 'voice') {
          <div class="flex flex-col items-center">
            <button 
              (click)="toggleRecording()" 
              [disabled]="isLoading()"
              class="flex items-center justify-center w-16 h-16 text-white transition-all duration-300 rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900 focus:ring-indigo-500"
              [class.bg-red-500]="isRecording() && !isLoading()"
              [class.hover:bg-red-600]="isRecording() && !isLoading()"
              [class.bg-indigo-500]="!isRecording() && !isLoading()"
              [class.hover:bg-indigo-600]="!isRecording() && !isLoading()"
              [class.hover:shadow-xl]="!isLoading()"
              [class.scale-110]="isRecording()"
              [class.bg-slate-400]="isLoading()" [class.dark:bg-slate-600]="isLoading()"
              [class.cursor-not-allowed]="isLoading()">
              <i class="text-2xl fa-solid" [class.fa-microphone-slash]="isRecording()" [class.fa-microphone]="!isRecording()"></i>
            </button>
            @if (isRecording()) {
              <p class="mt-2 text-xs font-medium text-center text-slate-500 dark:text-slate-400">Listening...</p>
            } @else {
              <p class="mt-2 text-xs text-center text-slate-500 dark:text-slate-400">Tap to speak</p>
            }
          </div>
        } @else {
          <form class="relative w-full" (submit)="sendTextMessage($event)">
            <input 
                class="w-full py-3 pl-5 pr-16 text-sm rounded-full shadow-md bg-white dark:bg-slate-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500"
                type="text" 
                placeholder="Type a message in French..." 
                [value]="textInputValue()"
                (input)="onTextInput($event)"
                [disabled]="isLoading()">
            <button 
                type="submit" 
                class="absolute inset-y-0 right-0 flex items-center justify-center w-16 h-full text-indigo-500 transition-colors rounded-r-full disabled:text-slate-400 disabled:cursor-not-allowed hover:text-indigo-600 dark:disabled:text-slate-500 dark:hover:text-indigo-400"
                [disabled]="!textInputValue().trim() || isLoading()">
                <i class="text-xl fa-solid fa-paper-plane"></i>
            </button>
          </form>
        }
      </div>

      <!-- Mode Toggle Button -->
      <div class="flex flex-col items-center flex-shrink-0">
        <button (click)="toggleChatMode()" 
          class="flex items-center justify-center w-14 h-14 rounded-full bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-zinc-100 dark:hover:bg-slate-600 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900 focus:ring-indigo-500"
          [attr.aria-label]="chatMode() === 'voice' ? 'Switch to text mode' : 'Switch to voice mode'">
          @if (chatMode() === 'voice') {
            <i class="text-2xl fa-solid fa-keyboard"></i>
          } @else {
            <i class="text-2xl fa-solid fa-microphone"></i>
          }
        </button>
        <p class="mt-1 text-xs text-center text-slate-500 dark:text-slate-400">
          @if (chatMode() === 'voice') { Tap to Text } @else { Tap to Speak }
        </p>
      </div>
    </div>
  </footer>
</div>

<!-- Vocabulary Bank Modal -->
@if (showVocabularyBank()) {
  <app-vocabulary-bank 
    [wordsForReview]="wordsDueForReview()"
    [otherWords]="otherWordsInBank()"
    [speakingRate]="userSettings().speakingRate"
    [frenchVoice]="frenchVoice"
    (close)="toggleVocabularyBank()"
    (review)="reviewWord($event)">
  </app-vocabulary-bank>
}

<!-- Session Review Modal -->
@if (showSessionReview()) {
  <app-session-review
    [isLoading]="isReviewLoading()"
    [reviewData]="sessionReviewData()"
    [unsavedWords]="unsavedWordsFromSession()"
    (close)="closeSessionReview()"
    (saveAll)="saveAllUnsavedWords()">
  </app-session-review>
}
